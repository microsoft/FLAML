<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flaml.searcher.flow2 &mdash; FLAML  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> FLAML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">FLAML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>flaml.searcher.flow2</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flaml.searcher.flow2</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;!</span>
<span class="sd"> * Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="sd"> * Licensed under the MIT License. See LICENSE file in the</span>
<span class="sd"> * project root for license information.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">flaml.tune.sample</span> <span class="kn">import</span> <span class="n">Domain</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">ray_version</span>

    <span class="k">assert</span> <span class="n">ray_version</span> <span class="o">&gt;=</span> <span class="s2">&quot;1.0.0&quot;</span>
    <span class="kn">from</span> <span class="nn">ray.tune.suggest</span> <span class="kn">import</span> <span class="n">Searcher</span>
    <span class="kn">from</span> <span class="nn">ray.tune.suggest.variant_generator</span> <span class="kn">import</span> <span class="n">generate_variants</span>
    <span class="kn">from</span> <span class="nn">ray.tune</span> <span class="kn">import</span> <span class="n">sample</span>
    <span class="kn">from</span> <span class="nn">ray.tune.utils.util</span> <span class="kn">import</span> <span class="n">flatten_dict</span><span class="p">,</span> <span class="n">unflatten_dict</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.suggestion</span> <span class="kn">import</span> <span class="n">Searcher</span>
    <span class="kn">from</span> <span class="nn">.variant_generator</span> <span class="kn">import</span> <span class="n">generate_variants</span>
    <span class="kn">from</span> <span class="nn">..tune</span> <span class="kn">import</span> <span class="n">sample</span>
    <span class="kn">from</span> <span class="nn">..tune.trial</span> <span class="kn">import</span> <span class="n">flatten_dict</span><span class="p">,</span> <span class="n">unflatten_dict</span>
<span class="kn">from</span> <span class="nn">..tune.space</span> <span class="kn">import</span> <span class="n">complete_config</span><span class="p">,</span> <span class="n">denormalize</span><span class="p">,</span> <span class="n">normalize</span>


<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="FLOW2"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2">[docs]</a><span class="k">class</span> <span class="nc">FLOW2</span><span class="p">(</span><span class="n">Searcher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Local search algorithm FLOW2, with adaptive step size&quot;&quot;&quot;</span>

    <span class="n">STEPSIZE</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">STEP_LOWER_BOUND</span> <span class="o">=</span> <span class="mf">0.0001</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">init_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">space</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prune_attr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_resource</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_resource</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resource_multiple_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">cost_attr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;time_total_s&quot;</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>

<span class="sd">        Args:</span>
<span class="sd">            init_config: a dictionary of a partial or full initial config,</span>
<span class="sd">                e.g. from a subset of controlled dimensions</span>
<span class="sd">                to the initial low-cost values.</span>
<span class="sd">                e.g. {&#39;epochs&#39;: 1}</span>
<span class="sd">            metric: A string of the metric name to optimize for.</span>
<span class="sd">            mode: A string in [&#39;min&#39;, &#39;max&#39;] to specify the objective as</span>
<span class="sd">                minimization or maximization.</span>
<span class="sd">            cat_hp_cost: A dictionary from a subset of categorical dimensions</span>
<span class="sd">                to the relative cost of each choice.</span>
<span class="sd">                e.g.,</span>

<span class="sd">                .. code-block:: python</span>

<span class="sd">                    {&#39;tree_method&#39;: [1, 1, 2]}</span>

<span class="sd">                i.e., the relative cost of the</span>
<span class="sd">                three choices of &#39;tree_method&#39; is 1, 1 and 2 respectively.</span>
<span class="sd">            space: A dictionary to specify the search space.</span>
<span class="sd">            prune_attr: A string of the attribute used for pruning.</span>
<span class="sd">                Not necessarily in space.</span>
<span class="sd">                When prune_attr is in space, it is a hyperparameter, e.g.,</span>
<span class="sd">                    &#39;n_iters&#39;, and the best value is unknown.</span>
<span class="sd">                When prune_attr is not in space, it is a resource dimension,</span>
<span class="sd">                    e.g., &#39;sample_size&#39;, and the peak performance is assumed</span>
<span class="sd">                    to be at the max_resource.</span>
<span class="sd">            min_resource: A float of the minimal resource to use for the</span>
<span class="sd">                prune_attr; only valid if prune_attr is not in space.</span>
<span class="sd">            max_resource: A float of the maximal resource to use for the</span>
<span class="sd">                prune_attr; only valid if prune_attr is not in space.</span>
<span class="sd">            resource_multiple_factor: A float of the multiplicative factor</span>
<span class="sd">                used for increasing resource.</span>
<span class="sd">            cost_attr: A string of the attribute used for cost.</span>
<span class="sd">            seed: An integer of the random seed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">],</span> <span class="s2">&quot;`mode` must be &#39;min&#39; or &#39;max&#39;.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;min&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FLOW2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="c1"># internally minimizes, so &quot;max&quot; =&gt; -1</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">space</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_space</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">prevent_delimiter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span> <span class="o">=</span> <span class="n">init_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">init_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span> <span class="o">=</span> <span class="n">prune_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span> <span class="o">=</span> <span class="n">min_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span> <span class="o">=</span> <span class="n">resource_multiple_factor</span> <span class="ow">or</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span> <span class="o">=</span> <span class="n">cost_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span> <span class="o">=</span> <span class="n">max_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
        <span class="k">if</span> <span class="n">space</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_search</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bounded_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unordered_cat_hp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hier</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;grid_search&quot;</span> <span class="ow">in</span> <span class="n">domain</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;s domain is grid search, not supported in FLOW^2.&quot;</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s2">&quot;get_sampler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">sampler</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_sampler</span><span class="p">()</span>
                <span class="c1"># the step size lower bound for uniform variables doesn&#39;t depend</span>
                <span class="c1"># on the current config</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Quantized</span><span class="p">):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">q</span>
                    <span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_sampler</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span><span class="p">,</span> <span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Uniform&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Categorical</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">ordered</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_unordered_cat_hp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hier</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">categories</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">hier</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;Normal&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bounded_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hier</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_space_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical</span> <span class="o">=</span> <span class="n">hier</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_resource</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hier</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_space_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">)</span>  <span class="c1"># flattened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">)</span>  <span class="c1"># total # tunable dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_complete4incumbent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proposed_by</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># trial_id: int -&gt; incumbent: Dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEPSIZE</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_lower_bound</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">lb</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="c1"># upper bound</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span>
        <span class="c1"># maximal # consecutive no improvements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict from trial_id to (config, stepsize)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_best_config</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_proposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_complete</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_times</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># record intermediate trial cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cost</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_same</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># whether the proposed config is the same as best_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># initial phase to increase initial stepsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># no truncation by default. when &gt; 0, it means how many</span>
        <span class="c1"># non-zero dimensions to keep in the random unit vector</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">step_lower_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">step_lb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_lb</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">get_sampler</span><span class="p">()</span>
            <span class="c1"># the stepsize lower bound for log uniform variables depends on the</span>
            <span class="c1"># current config</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Quantized</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">q</span>
                <span class="n">sampler_inner</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_sampler</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sampler_inner</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;LogUniform&quot;</span><span class="p">:</span>
                    <span class="n">step_lb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">step_lb</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">upper</span> <span class="o">/</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;LogUniform&quot;</span><span class="p">:</span>
                <span class="n">step_lb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">step_lb</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">domain</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">step_lb</span><span class="p">):</span>
            <span class="n">step_lb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEP_LOWER_BOUND</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step_lb</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span>
        <span class="k">return</span> <span class="n">step_lb</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resource</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span>

    <span class="k">def</span> <span class="nf">_min_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;automatically decide minimal resource&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;round the resource to self.max_resource if close to it&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span>
        <span class="k">return</span> <span class="n">resource</span>

    <span class="k">def</span> <span class="nf">rand_vector_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vec</span>

<div class="viewcode-block" id="FLOW2.complete_config"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.complete_config">[docs]</a>    <span class="k">def</span> <span class="nf">complete_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">partial_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;generate a complete config from the partial config input</span>
<span class="sd">        add minimal resource to config if available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disturb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_times</span> <span class="ow">and</span> <span class="n">partial_config</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span>
        <span class="c1"># if not the first time to complete init_config, use random gaussian</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">space</span> <span class="o">=</span> <span class="n">complete_config</span><span class="p">(</span>
            <span class="n">partial_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">disturb</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">partial_config</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_times</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">space</span></div>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">init_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">space</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Searcher</span><span class="p">:</span>
        <span class="c1"># space is the subspace where the init_config is located</span>
        <span class="n">flow2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">init_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">space</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_resource</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">flow2</span><span class="o">.</span><span class="n">best_obj</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span>  <span class="c1"># minimize internally</span>
        <span class="n">flow2</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">=</span> <span class="n">cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">flow2</span>

<div class="viewcode-block" id="FLOW2.normalize"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.normalize">[docs]</a>    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;normalize each dimension in config to [0,1]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span><span class="p">,</span> <span class="n">recursive</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FLOW2.denormalize"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.denormalize">[docs]</a>    <span class="k">def</span> <span class="nf">denormalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;denormalize each dimension in config from [0,1]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">denormalize</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FLOW2.set_search_properties"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.set_search_properties">[docs]</a>    <span class="k">def</span> <span class="nf">set_search_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">],</span> <span class="s2">&quot;`mode` must be &#39;min&#39; or &#39;max&#39;.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_space</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_search</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">on_trial_complete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">trial_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1"># compare with incumbent</span>
        <span class="c1"># if better, move, reset num_complete and num_proposed</span>
        <span class="c1"># if not better and num_complete &gt;= 2*dim, num_allowed += 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_complete</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">obj</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">trial_id</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cost_complete4incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_proposed_by</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># self._oldK must have been set when self._K&gt;0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldK</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iter_best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_complete</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">proposed_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proposed_by</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trial_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proposed_by</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span><span class="p">:</span>
            <span class="c1"># proposed by current incumbent and no better</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trial_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">cost</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cost_complete4incumbent</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span>
            <span class="p">):</span>
                <span class="c1"># check stuck condition if using max resource</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1"># elif proposed_by: del self._proposed_by[trial_id]</span>

<div class="viewcode-block" id="FLOW2.on_trial_result"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.on_trial_result">[docs]</a>    <span class="k">def</span> <span class="nf">on_trial_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;early update of incumbent&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_op</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">obj</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">best_obj</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">trial_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span> <span class="o">!=</span> <span class="n">config</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span> <span class="o">=</span> <span class="n">config</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_complete4incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_proposed_by</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_complete</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_attr</span><span class="p">)</span>
            <span class="c1"># record the cost in case it is pruned and cost info is lost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trial_cost</span><span class="p">[</span><span class="n">trial_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span></div>

    <span class="k">def</span> <span class="nf">rand_vector_unit_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">trunc</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">:</span>
            <span class="n">vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span> <span class="n">dim</span> <span class="o">-</span> <span class="n">trunc</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">mag</span>

<div class="viewcode-block" id="FLOW2.suggest"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.suggest">[docs]</a>    <span class="k">def</span> <span class="nf">suggest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trial_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;suggest a new config, one of the following cases:</span>
<span class="sd">        1. same incumbent, increase resource</span>
<span class="sd">        2. same resource, move from the incumbent to a random direction</span>
<span class="sd">        3. same resource, move from the incumbent to the opposite direction</span>
<span class="sd">        #TODO: better decouple FLOW2 config suggestion and stepsize update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_proposed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cost_complete4incumbent</span>
                <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># consider increasing resource using sum eval cost of complete</span>
            <span class="c1"># configs</span>
            <span class="n">old_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_multiple_factor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_incumbent</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">/</span> <span class="n">old_resource</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">trial_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return negative direction</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">):</span>
                <span class="n">move</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># propose a new direction</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rand_vector_unit_sphere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">):</span>
                <span class="n">move</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="p">(</span><span class="n">move</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">denormalize</span><span class="p">(</span><span class="n">move</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proposed_by</span><span class="p">[</span><span class="n">trial_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">trial_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_same</span><span class="p">:</span>
                    <span class="c1"># check if the new config is different from best_config</span>
                    <span class="n">same</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">best_config</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">same</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">same</span><span class="p">:</span>
                        <span class="c1"># increase step size</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STEPSIZE</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_ub</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># check if the new config is different from best_config</span>
                <span class="n">same</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">best_config</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">same</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_same</span> <span class="o">=</span> <span class="n">same</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_resource</span>
        <span class="p">):</span>
            <span class="c1"># check stuck condition if using max resource</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_proposedby_incumbent</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_lower_bound</span><span class="p">:</span>
                <span class="c1"># decrease step size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_oldK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_best_config</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_count_proposed</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oldK</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trunc</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># random</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction_tried</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">generated</span> <span class="ow">in</span> <span class="n">generate_variants</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span><span class="p">[</span><span class="n">key</span><span class="p">]}}</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">generated</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">generated</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">return</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if config == best_config</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_config</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">best_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="c1"># print(&#39;move to&#39;, move)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span> <span class="o">=</span> <span class="n">move</span>
        <span class="k">return</span> <span class="n">unflatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;project normalized config in the feasible region and set prune_attr&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounded_keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_suggest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;can&#39;t suggest if 2*dim configs have been proposed for the incumbent</span>
<span class="sd">        while fewer are completed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_allowed4incumbent</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="FLOW2.config_signature"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.config_signature">[docs]</a>    <span class="k">def</span> <span class="nf">config_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">space</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return the signature tuple of a config&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">space</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space</span>
        <span class="n">value_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># self._space_keys doesn&#39;t contain keys with const values,</span>
        <span class="c1"># e.g., &quot;eval_metric&quot;: [&quot;logloss&quot;, &quot;error&quot;].</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_space_keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">:</span>
                <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># key must be in space</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical</span><span class="p">:</span>
                    <span class="c1"># can&#39;t remove constant for hierarchical search space,</span>
                    <span class="c1"># e.g., learner</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Domain</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="c1"># not domain or hashable</span>
                        <span class="c1"># get rid of list type for hierarchical search space.</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">sample</span><span class="o">.</span><span class="n">Integer</span><span class="p">):</span>
                    <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value_list</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">converged</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;return whether the local search has converged&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_complete4incumbent</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># check stepsize after enough configs are completed</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_lower_bound</span>

<div class="viewcode-block" id="FLOW2.reach"><a class="viewcode-back" href="../../../index.html#flaml.FLOW2.reach">[docs]</a>    <span class="k">def</span> <span class="nf">reach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Searcher</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;whether the incumbent can reach the incumbent of other&quot;&quot;&quot;</span>
        <span class="n">config1</span><span class="p">,</span> <span class="n">config2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_config</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">best_config</span>
        <span class="n">incumbent1</span><span class="p">,</span> <span class="n">incumbent2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incumbent</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">incumbent</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource</span> <span class="ow">and</span> <span class="n">config1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">config2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prune_attr</span><span class="p">]:</span>
            <span class="c1"># resource will not decrease</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unordered_cat_hp</span><span class="p">:</span>
            <span class="c1"># unordered cat choice is hard to reach by chance</span>
            <span class="k">if</span> <span class="n">config1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">incumbent1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">incumbent2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tunable_keys</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2021, FLAML Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>